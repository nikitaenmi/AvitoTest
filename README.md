# Тестовое для Avito на позицию стажера backend-разработчика Go.


## Содержание

- [Тестовое задание](#тестовое-задание)
- [Архитектура](#архитектура)
- [Запуск проекта](#запуск-проекта)
- [Задача и реализация сервиса](#задача-и-реализация-сервиса)
- [Проверка работы и тестирование](#проверка-работы-и-тестирование)
- [Описание конфигурации линтера](#описание-конфигурации-линтера)
- [Описание переменнных окружения](#описание-переменных-окружения)
- [Отличительные черты](#отличительные-черты)


## Тестовое задание

### **Сервис назначения ревьюеров для Pull Request’ов**

Внутри команды требуется единый микросервис, который автоматически назначает ревьюеров на Pull Request’ы (PR), а также позволяет управлять командами и участниками. Взаимодействие происходит исключительно через HTTP API.

### **Описание задачи**

Необходимо реализовать сервис, который назначает ревьюеров на PR из команды автора, позволяет выполнять переназначение ревьюверов и получать список PR’ов, назначенных конкретному пользователю, а также управлять командами и активностью пользователей. После merge PR изменение состава ревьюверов запрещено.

### **Общие вводные**

**Пользователь (User)** — участник команды с уникальным идентификатором, именем и флагом активности `isActive`.

**Команда (Team)** — группа пользователей с уникальным именем.

**Pull Request (PR)** — сущность с идентификатором, названием, автором, статусом `OPEN|MERGED`и списком назначенных ревьюверов (до 2).

1. При создании PR автоматически назначаются **до двух** активных ревьюверов из **команды автора**, исключая самого автора.
2. Переназначение заменяет одного ревьювера на случайного **активного** участника **из команды заменяемого** ревьювера.
3. После `MERGED` менять список ревьюверов **нельзя**.
4. Если доступных кандидатов меньше двух, назначается доступное количество (0/1).

### **Условия**

* Используйте этот API (OpenAPI-спецификация будет предоставлена отдельным файлом — `openapi.yaml`).
* Объём данных умеренный (до 20 команд и до 200 пользователей), RPS — 5, SLI времени ответа — 300 мс, SLI успешности — 99.9%.
* Пользователь с `isActive = false` не должен назначаться на ревью.
* Операция merge должна быть **идемпотентной** — повторный вызов не приводит к ошибке и возвращает актуальное состояние PR.
* Сервис и его зависимости должны подниматься командой **docker-compose up**. Если решение предусматривает миграции, они также должны применяться при выполнении этой команды. Сервис должен быть доступен на порту 8080.
* Учтите, что соблюдение условий по поднятию сервиса ускорит и упростит проверку вашей работы наставниками.

### **Дополнительные задания**

Эти задания не являются обязательными, но выполнение всех или части из них даст вам преимущество перед другими кандидатами.

* Добавить простой эндпоинт статистики (например, количество назначений по пользователям и/или по PR).
* Провести нагрузочное тестирование полученного решения и приложить краткие результаты тестирования к решению.
* Добавить метод массовой деактивации пользователей команды и безопасную переназначаемость открытых PR (стремиться уложиться в 100 мс для средних объёмов данных).
* Реализовать интеграционное или E2E-тестирование.
* Описать конфигурацию линтера.

### **Требования по стеку**

**Язык сервиса:** предпочтительным будет Go, при этом вы можете выбрать любой, удобный вам.

**База данных:** предпочтительной будет PostgreSQL, при этом вы можете выбрать любую, удобную вам (допускается in-memory реализация).

### **Ход решения**

Если у вас возникнут вопросы по заданию, ответы на которые вы не найдёте в описанных «Условиях», вы вольны принимать решения самостоятельно.
В таком случае приложите к проекту README-файл, в котором будет список вопросов и пояснения о том, какие допущения вы сделали и почему именно выбранным вами способом.

### **Оформление решения**

Необходимо предоставить публичный git-репозиторий на любом публичном хосте (GitHub / GitLab / etc), содержащий в master/main ветке:

1. Код сервиса
2. Makefile c командами сборки проекта / Описанная в README.md инструкция по запуску
3. Описанные в README.md вопросы/проблемы, с которыми столкнулись, и ваша логика их решений (если требуется)



## Архитектура 

```bash
.
├── cmd
│   └── main.go                    - Точка входа приложения
├── internal
│   ├── domain                     - Доменный слой 
│   │   ├── domain.go              - Сущности
│   │   └── errors.go              - Доменные ошибки
│   ├── handlers                   - HTTP-хендлеры        
│   │   ├── handlers.go            - Конструктор и HealthCheck
│   │   ├── pr_handlers.go         - Хендлеры PL
│   │   ├── team_handlers.go       - Хендлеры команд
│   │   ├── user_handlers.go       - Хендлеры пользователей
│   │   ├── errors.go              - Обработчик ошибок
│   │   └── dto                    
│   │       └── dto.go 
│   ├── service                    - Бизнес-логика (сервисный слой)
│   │   ├── service.go             - Конструктор
│   │   ├── pr_service.go          - Сервсисный слой работы с PL
│   │   ├── team_service.go        - Сервсисный слой работы с командами
│   │   └── user_service.go        - Сервсисный слой работы с пользователями
│   ├── repository                 - Репозиторный слой
│   │   ├── repository.go          - Конструктор
│   │   ├── pr_repository.go       - Репо PL
│   │   ├── team_repository.go     - Репо команд
│   │   └── user_repository.go     - Репо пользователей
│   ├── database                   
│   │   ├── connections.go         - Подключение к БД 
│   │   └── models                 - Модели БД 
│   │       └── models.go          
│   └── config                     - Конфиг
│       └── config.go              
├── e2e                            - End-to-end тестирование
│   ├── e2e_test.go                
│   └── helpers_test.go            - Вспомогательные функции для тестирования
├── loadtest                       - Нагрузочное тестирование
│   ├── config.go                  - Конфигурация нагрузочного теста
│   ├── main.go                    - Запуск нагрузочного теста
│   └── test_helpers.go            - Вспомогательные функции для нагрузочного теста
├── migrations                     - Миграции базы данных
│   └── 001_init.sql               
├── Makefile                       - Мейкфайл
├── docker-compose.e2e.yml         - Docker-compose для е2е-тестирования
├── docker-compose.yml             - Основной docker-compose
├── Dockerfile                     - Образ приложения
├── Dockerfile.e2e                 - Образ для E2E тестов
├── go.mod                         - Модули Go (зависимости)
├── go.sum                         - Хеши зависимостей
├── README.md                      - Документация проекта
├── samples 
│   └── .env.example               - Пример .env-файла    
└── .env                           - .env-файл 
```

### Технологии

- Язык: Golang
- База данных: PostgreSQL
- Web-framework: Echo
- ORM: GORM


## Запуск проекта

Клонируйте репозиторий:
```sh
git clone https://github.com/nikitaenmi/AvitoTest
cd AvitoTest
```
Вызовите docker-compose:
```sh
docker-compose up
```


## Задача и реализация сервиса

- Задача создать сервис назначения ревьюеров для Pull Request’ов

### Реализация сервиса

- Выполнены все пункты общих вводных и условий задачи

- Из дополнительных задач реализованы Е2Е тестирование, нагрузочное тестирование и описание конфигурации линтера

- В сервисе реализованы все эндпоинты, указанные в OpenAPI-спецификации

- Сервис доступен на порту 8080

- Методы, ответы и коды HTTP полностью соответсвуют спецификации


## Проверка работы и тестирование

### Пример запроса

 Запрос:

```bash
curl -X POST http://localhost:8080/team/add \
  -H "Content-Type: application/json" \
  -d '{
    "team_name": "backend-team",
    "members": [
      {
        "user_id": "user-1",
        "username": "alice",
        "is_active": true
      },
      {
        "user_id": "user-2",
        "username": "bob",
        "is_active": true
      },
      {
        "user_id": "user-3",
        "username": "charlie",
        "is_active": false
      }
    ]
  }'
```

Ответ:

```bash
{
  "team": {
    "team_name": "backend-team",
    "members": [
      {
        "user_id": "user-1",
        "username": "alice",
        "team_name": "backend-team",
        "is_active": true
      },
      {
        "user_id": "user-2",
        "username": "bob",
        "team_name": "backend-team",
        "is_active": true
      },
      {
        "user_id": "user-3",
        "username": "charlie",
        "team_name": "backend-team",
        "is_active": false
      }
    ]
  }
}
```

### Результаты E2E тестирования

Е2Е тестирование проходит в отдельном docker-compose.e2e.yml


Вызов Е2Е тестирования:
```sh
make e2e
```

Результат:
```bash
e2e_tests          | --- PASS: TestE2ESuite (0.11s)
e2e_tests          | --- PASS: TestE2ESuite/Test01_CreateTeamAndPR (0.02s)
e2e_tests          | --- PASS: TestE2ESuite/Test02_ReassignReviewer (0.02s)
e2e_tests          | --- PASS: TestE2ESuite/Test03_ReassignPreventsDuplicates (0.03s)
e2e_tests          | --- PASS: TestE2ESuite/Test04_CannotReassignOnMergedPR (0.02s)
e2e_tests          | --- PASS: TestE2ESuite/Test05_UserActivityAffectsAssignment (0.02s)
e2e_tests          | --- PASS: TestE2ESuite/Test06_ReassignWithLimitedAvailableReviewers (0.01s)
e2e_tests          | PASS
e2e_tests          | ok         github.com/nikitaenmi/AvitoTest/e2e     0.116s
e2e_tests exited with code 0
```

### Результаты нагрузочного тестирования

Вызов нагрузочного тестирования:
```sh
docker-compose up
make loadtest
```

Результат:
```
Summary:
Total Requests:    1000
Successful:        1000 (100.0%)
Errors:            0 (0.0%)
Total Duration:    2.54 seconds
Requests/sec:      394.26
Avg. Latency:      122.06 ms

Request Types Breakdown:
Type                         Total  Success   Errors  Success %    Min(ms)    Max(ms)
get_team                       125      125        0     100.0%        10       280
create_team                    125      125        0     100.0%        54       564
create_team_duplicate          125      125        0     100.0%         5       214
set_user_active_invalid        125      125        0     100.0%         4       219
health_check                   125      125        0     100.0%         4       198
set_user_active                125      125        0     100.0%        12       300
create_pr_invalid              125      125        0     100.0%         6       311
create_pr                      125      125        0     100.0%        31       471
```


## Описание конфигурации линтера

```bash
linters:
  enable:
    - govet       - Проверка корректности кода (ошибки компиляции, тенирование переменных)
    - errcheck    - Проверка что ошибки обрабатываются (не игнорируются)
    - ineffassign - Обнаружение неэффективных присваиваний (переменные присваиваются но не используются)
    - unused      - Поиск неиспользуемого кода (переменные, функции, константы)
    - bodyclose   - Проверка закрытия HTTP response body
    - unparam     - Поиск неиспользуемых параметров функций
    - misspell    - Проверка орфографии в комментариях и строках
    - dupl        - Поиск дублированного кода
    - gocyclo     - Измерение цикломатической сложности функций
    - prealloc    - Рекомендации по предварительному выделению памяти для срезов
  disable:
    - staticcheck

formatters:
  enable:
    - gofmt      - Стандартный форматтер Go (базовое форматирование)
    - gofumpt    - Строгий форматтер (дополнительные правила форматирования)
    - goimports  - Форматирование и организация импортов
```


## Описание переменных окружения

- DB_HOST - хост PostgreSQL (по умолчанию: postgres)
- DB_PORT - порт PostgreSQL (по умолчанию: 5432)
- DB_USER - пользователь PostgreSQL (по умолчанию: root)
- DB_PASSWORD - пароль PostgreSQL (по умолчанию: root)
- DB_NAME - название базы данных (по умолчанию: pr_review)
- DB_SSL_MODE - режим SSL подключения (по умолчанию: disable)

- ServerSERVER_HOST - хост HTTP сервера (по умолчанию: 0.0.0.0)
- SERVER_PORT - порт HTTP сервера (по умолчанию: 8080)
- SERVER_READ_TIMEOUT - таймаут чтения запросов (по умолчанию: 10s)
- SERVER_WRITE_TIMEOUT - таймаут записи ответов (по умолчанию: 10s)
- SERVER_IDLE_TIMEOUT - таймаут простоя соединений (по умолчанию: 60s)

- BASE_URL - базовый URL для нагрузочного тестирования (по умолчанию: http://localhost:8080)
- TOTAL_REQUESTS - общее количество запросов в нагрузочном тесте (по умолчанию: 1000)
- CONCURRENCY - количество параллельных запросов (по умолчанию: 50)
- TIMEOUT - таймаут для каждого запроса в нагрузочном тесте (по умолчанию: 10s)


## Отличительные черты

- Чистая архитектура с разделением ответственноси
- Е2Е-тестирование в отдельном контейнере
- Нагрузочное тестирование
- Использован и описан линтер

